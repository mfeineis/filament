<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>playground : rye-suggestions</title>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
    <script>

     define("env/document", [], () => {
         return document;
     });

     define("env/custom-elements", [], () => {
         return window.customElements;
     });

     define("core/router", ["env/document", "env/custom-elements"], (document, customElements) => {

         const state = {
             guid: 0,
             queue: [],
             routes: {},
         };

         const validateMeta = meta => meta && meta.fragment && meta.module && meta.route;

         const nextTick = fn => setTimeout(fn, 0);

         const dispatchQueue = (state, meta) => {
             state.queue = state.queue.filter(({ route, next }) => {
                 if (meta.route === route) {
                     nextTick(() => {
                         requestWidget(state, route, next);
                     });
                     return false;
                 }

                 return true;
             });
         };

         const api = {
             register(meta) {
                 console.log('router.register', meta);

                 if (state.routes[meta.route]) {
                     console.error(`router.register: "${meta.route}" is already defined`);
                     return;
                 }

                 if (!validateMeta(meta)) {
                     console.error(`router.register: meta for "${meta.route}" invalid`);
                     return;
                 }

                 state.routes[meta.route] = {
                     meta,
                 };

                 dispatchQueue(state, meta);
             },
         };

         const requestWidget = (state, route, next) => {
             console.log("requestWidget", route);

             const registration = state.routes[route];
             console.log("  registration", registration);

             if (!registration) {
                 console.warn(`router.requestWidget: widget not found`);
                 state.queue.push({ timestamp: Date.now(), route, next });

                 console.log(`router.state`, state);
                 return;
             }

             const req = require.config({
                 paths: {
                     [registration.meta.module]: registration.meta.fragment.replace(/\.js$/, ''),
                 },
             });

             req([registration.meta.module], next);
         };

         customElements.define('router-fragment', class extends HTMLElement {
             constructor() {
                 super();

                 this.id = `rf-${state.guid}-${Date.now()}`;
                 state.guid += 1;
                 this.isDisposed = false;
             }

             connectedCallback() {
                 const route = this.getAttribute("route");
                 console.log("connected", route, this.id, this);

                 const root = document.createElement("div");
                 this.appendChild(root);

                 requestWidget(state, route, factory => {

                     if (this.isDisposed) {
                         console.log(`router.requestWidget: widget ${this.id} is disposed`);
                         return;
                     }

                     factory(root, { id: this.id });
                 });
             }

             disconnectedCallback() {
                 this.isDisposed = true;
             }
         });

         return api;
     });

     // "rye-suggestions" router registration
     require(["core/router"], ({ register }) => (
         register({
             fragment: "main.js",
             module: "rye-suggestions",
             route: "suggestions/user",
         })
     ));

    </script>

    <router-fragment route="suggestions/user" />
</body>
</html>
